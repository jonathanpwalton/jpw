#!/usr/bin/env bash

NAME="jpw"
VERSION="2025.03.25"
DESCRIPTION="a simplicty-focused package manager for GNU/Linux"

error() {
	printf "error: %s\n" "$1"
	exit 1
}

cwd() {
	cd "$1" || error "unable to cd $1"
}

require_root() {
	if [ "$EUID" -ne 0 ]; then
		error "you cannot use this command unless you are root"
	fi
}

usage() {
	printf "%s %s\n%s\n\n" "$NAME" "$VERSION" "$DESCRIPTION"

	printf "usage: %s <command>\n" "$0"

	printf "\ncommands:\n"
	printf "  %-25s %s\n" "get [pkg [-cfg=*]...]"		"retrieve and install package(s)"
	printf "  %-25s %s\n" "rid [pkg...]" 						"remove package(s) and associated files"
	printf "  %-25s %s\n" "via" 										"list packages installed via this utility"
	printf "  %-25s %s\n" "help" 										"print this help text and exit"
	printf "  %-25s %s\n" "about" 									"print the version, license stub, and warranty stub"

	printf "\npackage format:\n"
	printf "  <name>[:<version>]\n"
	
	printf "\nsubmit issue reports to <https://github.com/jonathanpwalton/jpw>\n"

	exit 0
}

declare -A installed=()

if [[ -e /var/cache/jpw/.installed ]]; then
	mapfile INSTALLED_LINES < /var/cache/jpw/.installed

	for INSTALLED_LINE in "${INSTALLED_LINES[@]}"; do
		IFS=':' read -ra LINE <<< "$INSTALLED_LINE"
		installed[${LINE[0]}]=${LINE[1]}
	done
fi

write_installed () {
	require_root
	rm -f /var/cache/jpw/.installed
	for pkg in "${!installed[@]}"; do
		echo "${pkg}:${installed[$pkg]}" >> /var/cache/jpw/.installed
	done
}

uninstall_package() {
	pkg=$1

	cd "/var/cache/jpw/$pkg" || error "failed to cd /var/cache/jpw/$pkg"

	if ! /usr/bin/env bash uninstall; then
		error "failed to uninstall $pkg"
	fi

	rm -rf "/var/cache/jpw/$pkg"
	unset "installed[$pkg]"
	write_installed
}

install_package() {
	pkg=$1
	ver=$2
	cfg=$3

	if [[ "${installed[$pkg]+1}" ]]; then
		printf "'%s' version '%s' was previously installed, do you wish to replace it with version '%s'? " "$pkg" "${installed[$pkg]}" "$ver"
		read -r answer

		if [[ ${answer,,} != "y" ]] && [[ ${answer,,} != "yes" ]]; then
			return
		fi

		uninstall_package "$pkg"
	fi

	tmpdir="$(mktemp)dir"
	mkdir "$tmpdir"
	cwd "$tmpdir"
	wget --no-cache -q --show-progress "https://raw.githubusercontent.com/jonathanpwalton/jpw/refs/heads/main/pkg/$pkg"

	case "$?" in
		4 ) error "network failure";;
		8 ) error "no such package $pkg";;
	esac

	if [[ $ver = latest ]]; then
		ver="$(/usr/bin/env bash "$pkg" latest)"
	fi

	if [[ -z $(/usr/bin/env bash "$pkg" versions "$ver" src) ]]; then
		error "no such version '$ver' for '$pkg'"
	fi

	dir="/var/cache/jpw/$pkg"
	src=$(/usr/bin/env bash "$pkg" versions "$ver" src)
	dst=$(/usr/bin/env bash "$pkg" versions "$ver" dst)
	build=$(/usr/bin/env bash "$pkg" versions "$ver" build)
	
	case "$src" in
		*.tar.* ) extract="tar xf";;
		* ) error "extraction unimplemented for $src";;
	esac

	mkdir -p "$dir"
	cwd "$dir"
	
	case "$build" in
		gnu )
			echo "
				set -e
				wget -q --show-progress $src
				$extract $dir/$(basename "$src")
				rm -f $dir/$(basename "$src")
				cd $dir/$dst
				./configure $cfg
				make
				make install
				make clean
			" > install

			echo "
				set -e
				cd $dir/$dst
				make uninstall
			" > uninstall
		;; * )
			error "building unimplemented for $build";;
	esac

	if ! /usr/bin/env bash install; then
		cwd "/"
		rm -rf "$dir"
		error "failed to install '$pkg' version '$ver'";
	fi

	installed[$pkg]=$ver
	write_installed
}

cmd=$1
shift

case "$cmd" in
	"" )
		error "command not supplied, try '$0 help' for more information";;
	help )
		usage;;
	about )
		printf "%s %s\nCopyright (C) 2025 Jonathan Walton\n\n" $NAME $VERSION
		printf "License GPLv3+: GNU GPL version 3 or later <https://www.gnu.org/licenses/gpl.html>\n"
    printf "This is free software: you are free to change and redistribute it.\n"
		printf "There is NO WARRANTY, to the extent permitted by law.\n";;
	get )
		require_root

		if [[ -z $1 ]]; then
			error "no package to get, try '$0 help' for more information"
		fi

		while (("$#")); do
			IFS=":" read -ra pkg_ver <<< "$1"
			shift

			if [[ -z ${pkg_ver[1]} ]]; then
				pkg_ver[1]="latest"
			fi

			if [[ $1 = --cfg=* ]]; then
				pre="--cfg="
				cfg=${1#"$pre"}
				shift
			fi

			install_package "${pkg_ver[0]}" "${pkg_ver[1]}" "$cfg"
		done;;
	rid )
		require_root

		if [[ -z $1 ]]; then
			error "no package to rid, try '$0 help' for more information"
		fi

		while (("$#")); do
			if [[ ! ${installed[$1]+1} ]]; then
				error "cannot rid not-installed package '$1'"
			fi

			uninstall_package "$1"
			shift
		done;;
	via )
		for pkg in "${!installed[@]}"; do
			printf "%s %s\n" "$pkg" "${installed[$pkg]}"
		done;;
	* )
		error "invalid command '$cmd', try '$0 help' for more information"
esac
